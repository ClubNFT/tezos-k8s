# Permissioned Chain

This tutorial will walk you through setting up a Tezos based
permissioned blockchain. Upon successful completion of this tutorial
you will have a permissioned chain running with three nodes in a
peer-to-peer network. This tutorial assumes the use of Minikube on
MacOS.


## Prerequisites
* homebrew
* minikube
* python3
* a ZeroTier network and api access token
* jq

## Installation

Make sure homebrew is installed:

``` shell
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
```

Install python3:

``` shell
brew install python3
```

Install jq:
``` shell
brew install jq
```

Ensure minikube is installed and running:

``` shell
brew install minikube
minikube start
```

Install the mkchain program:

``` shell
python3 -m venv .venv
source .venv/bin/activate
pip install https://github.com/tqtezos/tezos-k8s/archive/master.zip
```

Create a ZeroTier network:

* Go to https://my.zerotier.com
* Login with google credentials or create a new account
* Create a new API access token by clicking on the "Generate New
Token" button. Save the generated access token. e.g. "yEflQt726fjXuSUyQ73WqXvAFoijXkLt"
* Go to https://my.zerotier.com/network
* Create a new network by clicking on the "Create a Network"
button. Save the 16 character generated network
id. e.g. "1c33c1ced02a5eee"

Set environment variables so we can access these values with later commands:
``` shell
ZT_TOKEN=yEflQt726fjXuSUyQ73WqXvAFoijXkLt
ZT_NET=1c33c1ced02a5eee
```

Prepare your cluster storage for the node. On MacOS your storage
directory needs to be exported to Minikube via NFS:

``` shell
sudo sh -c 'echo "/System/Volumes/Data/Users/ -alldirs -mapall=501:1000 $(minikube ip)" >> /etc/exports'
sudo nfsd restart
```

Give your private chain a name:

``` shell
CHAIN_NAME=my_chain
```

Run the following command to create the chain:

``` shell
mkchain --create --baker --zerotier-network $ZT_NET
--zerotier-token $ZT_TOKEN $CHAIN_NAME | kubectl apply -f -
```

Your kubernetes cluster will now be running a series of jobs to
perform the following tasks:
* generate a node identity
* generate a genesis block for your chain
* activate the protocol
* bake the first block
* start the node and a baker to validate the chain

You can find your node in the tqtezos namespace using kubectl.

``` shell
kubectl -n tqtezos get pods
```

You can view logs for your node using the following command:
``` shell
kubectl -n tqtezos logs -l app=tezos-node -f
```

Congratulations! You now have an operational Tezos based permissioned
chain running one node.

## Add Nodes

Additional nodes can be added to your network by sharing a yaml file
generated by the mkchain invite command

### create the invitation

``` shell
IP=$(kubectl -n tqtezos exec  daemonsets/zerotier-bridge -- zerotier-cli get $ZT_NET ip)
mkchain --invite --bootstrap-peer $IP $CHAIN_NAME > join-$CHAIN_NAME.yaml
```

Share the resulting join-$CHAIN_NAME.yaml with your partner. Have them
apply this file to their Minikube cluster:

``` shell
kubectl apply -f join-$CHAIN_NAME.yaml
```

At this point additional nodes will be added in a star network
topology. In order to get nodes communicating via p2p one of the nodes
must be told about the VPN addresses used by the clients.

The following command can be used to force a peering connection over
the VPN network.

``` shell
curl -H "Authorization: bearer $ZT_TOKEN" \
https://my.zerotier.com/api/network/$ZT_NET/member|jq -r ".[].config.ipAssignments[0]" | while read i
do
    kubectl -n tqtezos exec deployment/tezos-node -- /usr/local/bin/tezos-admin-client connect address $i:30732
done
```

Congratulations! You now have a multi-node Tezos based permissioned
chain.
